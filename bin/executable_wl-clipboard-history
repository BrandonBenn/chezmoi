#!/usr/bin/env bash
#
# wl-clipboard-history: Wayland clipboard history tracker
#

set -euo pipefail

CLIPBOARD_DB=~/.local/share/wl-clipboard.db

query() {
    echo "$1" | sqlite3 -separator "," "$CLIPBOARD_DB"
}

if [ ! -f "$CLIPBOARD_DB" ]; then
    query "
    CREATE TABLE c (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, contents text);
    CREATE TRIGGER rotate_rows AFTER INSERT ON c
   BEGIN
     DELETE FROM c WHERE id <= (SELECT id FROM c ORDER BY id DESC LIMIT 1000, 1);
   END;"
fi

listen() {
    wl-paste -w wl-clipboard-history
}

usage() {
    echo "Usage: $0 OPTION [ARG]"
    echo ""
    echo "Without any arguments the command will insert contents of stdin in the database"
    echo "   -d           Track clipboard daemon"
    echo "   -l [NUMBER]  Print last NUMBER of clipboard entries (defaults to 10 entries)"
    echo "   -p [INDEX]   Print clipboard entry at INDEX (defaults to the last entry)"
}

if [ $# = 0 ]; then
    contents="$(sed </dev/stdin "s/'/''/g")"
    if [ "$contents" = "" ]; then
        usage
        exit 1
    else
        query "INSERT INTO c (contents) VALUES ('${contents}');"
        exit 0
    fi
fi

if [ "$1" = "-d" ]; then
    listen
elif [ "$1" = "-c" ]; then
    wl-clipboard-history -p "$(wl-clipboard-history -l 20 | fzf --with-nth 2.. -d , | cut -d ',' -f1)" | wl-copy
elif [ "$1" = "-l" ]; then
    query "SELECT MAX(id), REPLACE(contents, '
', '') FROM c GROUP BY contents ORDER BY id DESC LIMIT ${2:-10}"
elif [ "$1" = "-p" ]; then
    query "SELECT contents FROM c WHERE id = ${2:-"(SELECT id FROM c ORDER BY id DESC)"}"
else
    usage
    exit 1
fi
